{% extends "base.html" %}

{% block content %}
<div class="chat-container" id="chat-container">
    <div class="chat-box assistant">
        <div class="chat-message">Olá! Eu sou seu consultor de investimentos. Vamos começar? Qual é o seu nome?</div>
    </div>
</div>
<div class="chat-input-container">
    <form id="chat-form">
        <div class="form-group">
            <input type="text" class="form-control" id="chat-input" required autocomplete="off">
        </div>
        <button type="submit" class="btn btn-primary">Enviar</button>
    </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    const chatContainer = document.getElementById('chat-container');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    let step = 0;
    const userData = {};

    const questions = [
        "Qual é a sua idade?",
        "Qual é o seu objetivo financeiro?",
        "Qual é a sua tolerância ao risco?",
        "Quais são seus investimentos atuais?",
        "Qual é a sua renda mensal?",
        "Quais são suas despesas mensais?",
        "Qual é o seu horizonte de tempo (em anos)?",
        "Qual é a sua experiência com investimentos?"
    ];

    const fields = [
        "nome",
        "idade",
        "objetivo",
        "tolerancia_risco",
        "investimentos",
        "renda_mensal",
        "despesas_mensais",
        "horizonte_tempo",
        "experiencia_investimentos"
    ];

    chatForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const userMessage = chatInput.value;
        addMessage('user', userMessage);
        userData[fields[step]] = userMessage;
        chatInput.value = '';
        step++;
        if (step < questions.length) {
            setTimeout(() => addMessage('assistant', questions[step]), 1000);
        } else {
            setTimeout(sendUserData, 1000);
        }
    });

    function addMessage(role, message) {
        const chatBox = document.createElement('div');
        chatBox.className = `chat-box ${role}`;
        const chatMessage = document.createElement('div');
        chatMessage.className = 'chat-message';
        chatMessage.innerText = message;
        chatBox.appendChild(chatMessage);
        chatContainer.appendChild(chatBox);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        chatInput.focus();
    }

    function sendUserData() {
        fetch('/gerar-recomendacao', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(userData)
        })
        .then(response => response.json())
        .then(data => {
            setTimeout(() => addMessage('assistant', data.recomendacao), 1000);
            chatForm.classList.add('d-none');
        })
        .catch(error => console.error('Error:', error));
    }

    chatInput.focus();
});
</script>
{% endblock %}